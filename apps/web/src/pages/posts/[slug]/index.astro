---
import { Icon } from 'astro-icon/components'
import { PortableText } from 'astro-portabletext'
import type { SomePortableTextComponents } from 'astro-portabletext/types'
import { Image } from 'astro:assets'
import { DateTime, Duration, Effect, Exit, Schema } from 'effect'

import * as Components from '~/components'
import silly from '~/content/silly.png'
import Eye from '~/Eye.astro'
import Layout from '~/Layout.astro'
import * as AstroContext from '~/lib/AstroContext'
import * as Post from '~/lib/Post'
import { Runtime } from '~/lib/Runtime'
import { UrlSlug } from '~/lib/Slug'

const getPost = Effect.gen(function* () {
  const postService = yield* Post.Service
  const params = yield* AstroContext.Params

  const { slug } = yield* Schema.decodeUnknown(
    Schema.Struct({ slug: UrlSlug })
  )(params)

  return yield* postService.getBySlug(slug)
})

const result = await Runtime.runPromiseExit(
  getPost.pipe(Effect.provide(AstroContext.layerRequest(Astro)))
)

if (Exit.isFailure(result)) {
  console.error(result.cause)
  throw new Error('Unable to load post from Sanity')
}

const components = {
  type: {
    code: Components.Code,
    image: Components.Image,
  },
} as const satisfies SomePortableTextComponents

const post = result.value
const date = DateTime.formatIsoDate(post.publicationDate)

const ogImage = new URL(
  `/posts/${post.slug}/og.png`,
  import.meta.env.SITE
).toString()

const cloudflareCacheLength = Duration.toSeconds(Duration.days(1))
const browserCacheLength = Duration.toSeconds(Duration.hours(1))

Astro.response.headers.set(
  'Cache-Control',
  `public, s-maxage=${cloudflareCacheLength}, max-age=${browserCacheLength}, stale-while-revalidate=${cloudflareCacheLength}`
)
---

<Layout title={post.title} description={post.description} ogImage={ogImage}>
  <a href='/' class='inline-flex flex-row items-center gap-1 underline'>
    <Icon name='lucide:arrow-left' class='h-4 w-4' />
    Back
  </a>

  <article class='prose lg:prose-lg dark:prose-invert mx-auto pb-8'>
    <div class='flex flex-col'>
      <h2
        class='text-3xl leading-tight font-black lg:text-4xl'
        transition:name={`post-${post.id}--title`}
      >
        {post.title}
      </h2>
      <div class='inline-flex flex-row items-center gap-1.5'>
        <Icon name='lucide:calendar' class='h-4 w-4' />
        <time
          class='text-md text-slate-600 dark:text-slate-300'
          transition:name={`post-${post.id}--date`}
        >
          {date}
        </time>
      </div>
    </div>
    <PortableText value={post.body} components={components} />
  </article>
  <Image
    transition:name='mackie'
    src={silly}
    height={200}
    alt='Mackie looking at the blog post'
    class='fixed bottom-0 left-0 -z-10 hidden h-[200px] duration-500 lg:block'
  />
  <div class='motion-reduce:hidden'>
    <Eye id='left-eye' class='bottom-[93px] left-[64px]' />
    <Eye id='right-eye' class='bottom-[96px] left-[100px]' />
  </div>
</Layout>

<script>
  document.addEventListener('astro:page-load', () => {
    const { matches } = window.matchMedia('(prefers-reduced-motion: reduce)')

    if (matches) {
      // Don't animate eyes because they are hidden!
      return
    }

    const $leftEye = document.getElementById('left-eye')
    const $rightEye = document.getElementById('right-eye')

    if (!$leftEye || !$rightEye) {
      return
    }

    window.addEventListener('mousemove', (e) => {
      const originX = $leftEye.offsetLeft + $leftEye.offsetWidth
      const originY = $leftEye.offsetTop + $leftEye.offsetHeight
      const mouseX = e.clientX
      const mouseY = e.clientY

      const radians = Math.atan2(originY - mouseY, originX - mouseX)

      $leftEye.style.transform = `rotate(${radians}rad)`
      $rightEye.style.transform = `rotate(${radians}rad)`
    })
  })
</script>
